.. _usage_expression:

Parcellating expression data
============================

.. _usage_expression_basic:

Basic usage
-----------

Once you've downladed the microarray data and selected your parcellation you
can process the data. This is as simple as:

.. doctest::

    >>> expression = abagen.get_expression_data(atlas['image'], atlas['info'])

.. note::

    By default this function will use data from *all* the donors! Wrangling all
    this raw microarray data can be quite time-consuming, so if you'd like to
    speed up this step make sure you've performed the :ref:`io_installation`.
    Alternatively, if you don’t want to use all the donors you can provide the
    subject IDs of the donors you want (e.g., ``donors=['9861', '10021']``).

The :func:`abagen.get_expression_data` function will print out some information
about what's happening as it goes. However, briefly the function:

    1. Fetches the microarray data from AHBA (if this has not already been
       done). Refer to parameters ``data_dir`` and ``donors`` for more info.
    2. Updates the MNI coordinates of all the tissue samples from AHBA using
       the coordinates from the ``alleninf`` package. This occurs by default;
       refer to parameter ``corrected_mni`` for more info.
    3. Mirrors samples across hemispheres to increase spatial coverage. This
       does not occur by default; refer to parameter ``lr_mirror`` for more
       info (or see :ref:`usage_expression_lrmirror`).
    4. Reannotates microarray probe-to-gene mappings with information from
       Arnatkevic̆iūtė et al., 2019, NeuroImage. This occurs by default; refer
       to parameter ``reannotated`` for more info.
    5. Performs intensity-based filtering of probes to remove those that do not
       exceed background noise. This occurs by default with a threshold of
       0.5 (i.e., probes must exceed background noise in 50% of all tissue
       samples); refer to parameter ``ibf_threshold`` for more info.
    6. Selects a representative probe amongst those probes indexing the same
       gene. This occurs by default by selecting the probe with the highest
       differential stability amongst donors; refer to parameter
       ``probe_selection`` for more info (or see :ref:`usage_probe_selection`).
    7. Matches tissue samples to regions in the user-specified ``atlas`` and
       aggregates samples within each region separately for each donor. Refer
       to parameters ``atlas``, ``atlas_info``, ``exact``, ``tolerance``, and
       ``metric`` for more info (or see :ref:`usage_expression_exact`).
    8. Normalizes expression values for each gene across brain regions for each
       donor. This occurs by default using a scaled robust sigmoid
       normalization function; refer to parameter ``donor_norm`` for more info.
    9. Aggregates expression data across all donors. This occurs by default
       by averaging the expression values; refer to parameters ``metric`` and
       ``return_donors`` for more info.

You can investigate all these parameters and options for modifying how the
``expression`` array is generated by looking at the :ref:`api_ref`.

.. _usage_expression_dataframe:

The parcellated expression DataFrame
------------------------------------

The ``expression`` object returned by :func:`abagen.get_expression_data` is a
``pandas.DataFrame``, where rows correspond to region labels as defined in the
atlas image, columns correspond to genes, and entry values are microarray
expression data normalized and aggregated across donors:

.. doctest::

    >>> print(expression)
    gene_symbol      A1BG  A1BG-AS1       A2M  ...       ZYX     ZZEF1      ZZZ3
    label                                      ...
    1            0.533064  0.792167  0.447196  ...  0.521263  0.224733  0.396009
    2            0.421408  0.716915  0.460235  ...  0.419497  0.117964  0.558332
    3                 NaN       NaN       NaN  ...       NaN       NaN       NaN
    ...               ...       ...       ...  ...       ...       ...       ...
    81           0.387847  0.045987  0.473161  ...  0.092883  0.596697  0.410640
    82           0.796091  0.134167  0.372935  ...  0.140178  0.279248  0.716110
    83           0.356067  0.022527  0.802499  ...  0.279927  0.886430  0.470536
    <BLANKLINE>
    [83 rows x 15656 columns]


By default the data are normalized using a scaled robust sigmoid function such
that expression values for a given gene will range from 0-1, where 0 indicates
the region with the lowest expression of that gene and 1 indicates the region
with highest.

Since the generated DataFrame is an aggregate (default: average) of multiple
donors it is possible (likely) that a given region may not have any expression
values *exactly* equal to 0 or 1.

.. _usage_expression_dense:

Getting dense expression data
-----------------------------

Unfortunately, due to how tissue samples were collected from the donor brains
it is possible that some regions in an atlas may not be represented by any
expression data. As you can see above, the third row in the returned DataFrame
is filled with NaN values. That region, corresponding to the right frontal pole
in the Desikan-Killiany atlas, was not matched to any tissue samples; this is
likely due to the fact that only two of the six donors have tissue samples
taken from the right hemisphere.

If you require a *dense* matrix---that is, you need expression values for
**every** region in your ``atlas``---there are a few parameters that you can
consider tuning to try and achieve this.

.. _usage_expression_exact:

Inexact matching with the ``exact`` parameter
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

By default, the :func:`~.get_expression_data` function will attempt to be as
precise as possible in matching microarray samples with brain regions. It takes
the following steps to do this for each tissue sample:

    1. Determine if the sample falls directly within a region of ``atlas``.
    2. Check to see if the sample is close to any regions by slowly expanding
       the search space (in 1mm increments) to include nearby voxels up to a
       specified distance threshold (specified via the ``tolerance``
       parameter).
    3. If there are multiple nearby regions, determine which region is closer
       by calculating the center-of-mass of the abutting regions.

If at any step a sample can be assigned to a region in ``atlas`` the sample is
assigned to that region and the matching procedure is terminated. However, as
we saw, regions with no assigned samples from any donor are simply left as NaN.

If you would like to force all regions to be assigned at least one sample you
can set ``exact=False``. By doing this, the function will go through the
normal procedure documented above and then, once all samples are matched,
check for any remaining "empty" regions and assign them the expression values
of the sample falling closest to the center of mass of that region. In this
way every brain region is matched to *at least* one sample.

Thus, passing ``exact=False`` when calling :func:`~.get_expression_data` will
return a dense matrix (at the expense of some anatomical precision):

.. insert figure demonstration matching of samples with ``exact`` parameter

.. doctest::
    :options: +SKIP

    >>> exp_exact = abagen.get_expression_data(atlas['image'], atlas['info'], exact=False)
    >>> print(exp_exact)
    gene_symbol      A1BG  A1BG-AS1       A2M  ...       ZYX     ZZEF1      ZZZ3
    label                                      ...
    1            0.524360  0.790998  0.445545  ...  0.529348  0.224699  0.391277
    2            0.415996  0.715841  0.462067  ...  0.424328  0.117925  0.553627
    3            0.648735  0.994571  0.205451  ...  0.488812  0.024174  0.718533
    ...               ...       ...       ...  ...       ...       ...       ...
    81           0.387863  0.045774  0.473089  ...  0.093229  0.596697  0.410640
    82           0.792881  0.133295  0.372055  ...  0.143174  0.279238  0.715495
    83           0.355565  0.022527  0.802119  ...  0.282611  0.886450  0.469348
    <BLANKLINE>
    [83 rows x 15656 columns]


.. _usage_expression_lrmirror:

Duplicating samples with the ``lr_mirror`` parameter
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If your parcellation is sufficiently low-resolution it is likely that most
regions in the left hemisphere (for which all six donors have tissue samples)
will be matched to at least one sample, whereas regions in the right hemisphere
may come up short.

To remedy this you can try setting the ``lr_mirror`` parameter to ``True`` when
calling :func:`~.get_expression_data`. This, as the name suggests, performs a
left/right mirroring of all the tissue samples from all donors. That is, all
samples in the left hemisphere are duplicated and mirrored onto the right
hemisphere, and vice-versa for right to left. Unlike the ``exact=False``
parameter this will not *guarantee* that all regions are matched to a sample,
but it will dramatically increase the likelihood that this will happen:

.. insert figure demonstrating duplication of samples across hemispheres

.. doctest::
    :options: +SKIP

    >>> exp_mirror = abagen.get_expression_data(atlas['image'], atlas['info'], lr_mirror=True)
    >>> print(exp_mirror)
    gene_symbol      A1BG  A1BG-AS1       A2M  ...       ZYX     ZZEF1      ZZZ3
    label                                      ...
    1            0.652426  0.774026  0.359871  ...  0.517450  0.311367  0.490487
    2            0.536944  0.616062  0.381963  ...  0.492545  0.162643  0.463119
    3            0.917679  0.370264  0.317911  ...  0.357439  0.359224  0.935759
    ...               ...       ...       ...  ...       ...       ...       ...
    81           0.339675  0.044840  0.285005  ...  0.080648  0.608044  0.381425
    82           0.828870  0.168068  0.418436  ...  0.103946  0.364523  0.744152
    83           0.338746  0.021799  0.824666  ...  0.279235  0.904594  0.476128
    <BLANKLINE>
    [83 rows x 15656 columns]


Note that since this effectively duplicates the number of tissue samples the
function runtime will increase somewhat. Also notice how the ``lr_mirror``
parameter changes the expression values for all the regions more dramatically
than the ``exact=True`` parameter. It is worth considering which (if either!)
of these options best suits your intended analysis.
