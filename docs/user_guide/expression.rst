.. _usage_expression:

Parcellating expression data
============================

Basic usage
-----------

Once you've downladed the microarray data and selected your parcellation you
can process the data. This is as simple as:

.. code-block:: python

    >>> expression = abagen.get_expression_data(atlas['image'], atlas['info'])

.. note::

    Wrangling all the raw microarray data can be quite time-consuming! If you'd
    like to speed up this step make sure you've performed the
    :ref:`io_installation`.

The :func:`~.get_expression_data` function will print out some information
about what's happening as it goes. However, briefly the function:

    1. Fetches the microarray data from AHBA (if this has not already been
       done). Refer to parameters ``data_dir`` and ``donors`` for more info.
    2. Updates the MNI coordinates of all the tissue samples from AHBA using
       the coordinates from the ``alleninf`` package. This occurs by default;
       refer to parameter ``corrected_mni`` for more info.
    3. Mirrors samples across hemispheres to increase spatial coverage. This
       does not occur by default; refer to parameter ``lr_mirror`` for more
       info.
    4. Reannotates microarray probe-to-gene mappings with information from
       Arnatkevic̆iūtė et al., 2019, NeuroImage. This occurs by default; refer
       to parameter ``reannotated`` for more info.
    5. Performs intensity-based filtering of probes to remove those that do not
       exceed background noise. This occurs by default with a threshold of
       0.5 (i.e., probes must exceed background noise in 50% of all tissue
       samples); refer to parameter ``ibf_threshold`` for more info.
    6. Selects a representative probe amongst those probes indexing the same
       gene. This occurs by default by selecting the probe with the highest
       differential stability amongst donors; refer to parameter
       ``probe_selection`` for more info.
    7. Matches tissue samples to regions in the user-specified ``atlas`` and
       aggregates samples within each region separately for each donor. Refer
       to parameters ``atlas``, ``atlas_info``, ``exact``, ``tolerance``, and
       ``metric`` for more info.
    8. Normalizes expression values for each gene across brain regions for each
       donor. This occurs by default using a scaled robust sigmoid
       normalization function; refer to parameter ``donor_norm`` for more info.
    9. Aggregates expression data across all donors. This occurs by default
       by averaging the expression values; refer to parameters ``metric`` and
       ``return_donors`` for more info.

You can investigate all these parameters and options for modifying how the
``expression`` array is generated by looking at the :ref:`api_ref` (and, in
particular, the reference for :func:`abagen.get_expression_data`).


The expression DataFrame
------------------------

The ``expression`` object returned by :func:`~.get_expression_data` is a
``pandas.DataFrame``, where rows correspond to region labels as defined in the
atlas image, columns correspond to genes, and entry values are microarray
expression data normalized and aggregated across donors:

.. code-block:: python

    >>> expression.head()
    gene_symbol      A1BG  A1BG-AS1       A2M  ...       ZYX     ZZEF1      ZZZ3
    label                                      ...
    1            0.533064  0.792167  0.447196  ...  0.521263  0.224733  0.396009
    2            0.421408  0.716915  0.460235  ...  0.419497  0.117964  0.558332
    3                 NaN       NaN       NaN  ...       NaN       NaN       NaN
    4            0.549249  0.838032  0.452455  ...  0.459863  0.186333  0.651721
    5            0.567021  0.698175  0.468942  ...  0.640709  0.258093  0.648954

    [5 rows x 15656 columns]

By default the data are normalized using a scaled robust sigmid function, such
that expression values for a given gene will range from 0-1, where 0 indicates
the region with the lowest expression of that gene and 1 indicates the region
with highest.

Since the generated DataFrame is an aggregate (default: average) of multiple
donors it is possible (see: likely) that a given region may not have any
expression values exactly equal to 0 or 1.

Getting dense expression data
-----------------------------

Unfortunately, due to how tissue samples were collected from the donor brains
it is possible that some regions in an atlas may not be represented by any
expression data. As you can see above, the third row in the return DataFrame is
filled with NaN values. That region, corresponding to the right frontal pole in
the Desikan-Killiany atlas, was not matched to any tissue samples; this is
likely due to the fact that only two of the six donors have tissue samples
taken from that hemisphere.

If you require a *dense* matrix---that is, you need expression values for
**every** region in your ``atlas``---there are a few parameters that you can
consider tuning to try and achieve this.

Inexact matching with the ``exact`` parameter
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

By default (``exact=True``), the `get_expression_data()` function will attempt
to be as precise as possible in matching microarray samples with brain regions.
It takes the following steps to do this for each tissue sample:

    1. Determine if the sample falls directly within a region of ``atlas``.
    2. Check to see if the sample is close to any regions by slowly expanding
       the search space (in 1mm increments) to include nearby voxels up to a
       specified distance threshold (specified via the ``tolerance``
       parameter).
    3. If there are multiple nearby regions, determine which region is closer
       by calculating the center-of-mass of the abutting regions.

If at any step a sample can be assigned to a region in ``atlas`` the sample is
assigned to that region and the matching procedure is terminated. However, as
we saw, regions with no assigned samples from any donor are simply left as NaN.

If you would like to force all regions to be assigned at least one sample you
can set ``exact=False``. By doing this, the function will go through the
normal procedure documented above and then, once all samples are matched,
check for any remaining "empty" regions and assign them the expression values
of the sample falling closest to the center of mass of that region. In this
way every brain region is matched to *at least* one sample.

Thus, passing ``exact=False`` when calling `get_expression_data()` will return
a dense matrix (at the expense of some anatomical precision):

.. code-block:: python

    >>> expression = abagen.get_expression_data(atlas['image'], atlas['info'], exact=False)
    >>> expression.head()
    gene_symbol      A1BG  A1BG-AS1       A2M  ...       ZYX     ZZEF1      ZZZ3
    label                                      ...
    1            0.524360  0.790998  0.445545  ...  0.529348  0.224699  0.391277
    2            0.415996  0.715841  0.462067  ...  0.424328  0.117925  0.553627
    3            0.648735  0.994571  0.205451  ...  0.488812  0.024174  0.718533
    4            0.539868  0.837423  0.452040  ...  0.466133  0.186292  0.648177
    5            0.557438  0.696790  0.466517  ...  0.645380  0.258093  0.646342

    [5 rows x 15656 columns]

Duplicating samples with the ``lr_mirror`` parameter
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

<WORK IN PROGRESS>
